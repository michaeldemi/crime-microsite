<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Window Guardian - Is Your Home Safe?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            letter-spacing: -0.25px;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .map-bg {
            background-image: url('https://images.unsplash.com/photo-1573283984368-8059329d0a35?q=80&w=2960&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .comparison-list-collapsed li:nth-child(n+5) {
            display: none;
        }
        /* Leaflet Map Container */
        #map {
            height: 325px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="relative min-h-screen w-full map-bg">
        <div class="absolute inset-0 bg-blue-900/50 backdrop-blur-sm"></div>

        <!-- Header -->
        <header class="relative z-10 p-4 bg-[#0e2a47]">
            <div class="container mx-auto flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 256 256" class="text-white"><path fill="currentColor" d="M224 48H32a16 16 0 0 0-16 16v128a16 16 0 0 0 16 16h192a16 16 0 0 0 16-16V64a16 16 0 0 0-16-16m-96 64a24 24 0 1 1-24-24a24 24 0 0 1 24 24m88 96H40V71.61l44.2-22.1a8 8 0 0 1 7.6 0L136 71.29V64a16 16 0 0 0-16-16a15.82 15.82 0 0 0-11.42 5.21a40 40 0 1 0-49.16 49.16A15.82 15.82 0 0 0 48 120a16 16 0 0 0 16 16h.31l-24.09 12.05A8 8 0 0 1 32 140.44V192h184Z"/></svg>
                <h1 class="text-2xl font-bold text-white text-[#0F2A3D] tracking-[-0.25px]">Window Guardian</h1>
            </div>
        </header>

        <main class="relative z-10 container mx-auto p-4 md:p-8 flex flex-col items-center justify-end md:justify-center min-h-[calc(100vh-80px)]">

            <!-- Home Screen -->
            <div id="home-screen" class="w-full max-w-md bg-white pt-4 pr-4 pl-4 pb-2 md:pt-8 md:pr-8 md:pl-8 md:pb-4 rounded-xl shadow-2xl fade-in">
                <h2 class="text-3xl font-bold text-gray-800 mb-2 text-[#0F2A3D] tracking-[-0.25px]">Is Your Home Safe?</h2>
                <p class="text-gray-600 mb-6">Window Guardian: Trusted by families for home safety</p>
                <form id="search-form">
                    <input type="text" id="fsa-input" placeholder="Postal code (first 3)" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" maxlength="3">
                    <p class="text-sm text-gray-500 mt-2">Enter your postal code to see break-in stats for your area.</p>
                    <!-- Add mt-4 (16px margin-top) to the search button for spacing above it -->
                    <button id="search-btn" type="submit" class="w-full bg-[#8c6d44] text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-[#7a5f3a] transition-transform transform hover:scale-105 flex items-center justify-center disabled:bg-gray-400">
                        <span class="btn-text">See break-ins near me</span>
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden btn-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
                <p id="error-message" class="text-red-500 mt-4"></p>
            </div>

            <!-- All other screens are managed here -->
            <div id="content-container" class="w-full max-w-md hidden">
                <!-- This will be populated by JS -->
            </div>

        </main>
    </div>

    <!-- Templates for different screens -->
    <template id="result-template">
        <div class="bg-white/90 backdrop-blur-md p-4 md:p-6 rounded-xl shadow-2xl text-gray-800 fade-in">
            <button class="change-area-btn text-blue-600 font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                Change area
            </button>
            <div class="bg-[#0e2a47] text-white p-6 rounded-lg mb-4">
                <h3 class="text-xl font-semibold mb-1 text-white tracking-[-0.25px]" id="result-fsa-header"></h3>
                <p class="text-sm text-gray-300 mb-4">Source: York Regional Police</p>
                <div class="flex justify-around text-left">
                    <div>
                        <p class="text-5xl font-bold" id="result-monthly-count">3</p>
                        <p class="text-gray-300 text-sm" id="result-monthly-name">Last 30 Days</p>
                    </div>
                    <div class="border-l border-gray-500"></div>
                    <div>
                        <p class="text-5xl font-bold" id="result-yearly-count">14</p>
                        <p class="text-gray-300 text-sm">Last 12 months</p>
                    </div>
                </div>
            </div>
            <a href="#" class="view-map-btn block py-3 border-b border-gray-300 hover:bg-gray-100/50 rounded-t-lg px-2 flex justify-between items-center">Open York Region map <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></a>
            <a href="#" class="view-comparison-btn block py-3 hover:bg-gray-100/50 rounded-b-lg px-2 flex justify-between items-center">See break-ins by area

 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></a>
            <div class="mt-4 pt-6 border-t border-gray-300">
                <h3 class="lead-gen-heading text-2xl font-bold mb-1 text-[#0F2A3D] tracking-[-0.25px]"></h3>
                <form class="lead-gen-form">
                    <input type="email" required placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mt-2 focus:ring-2 focus:ring-blue-500">
                    <div class="flex items-start gap-2 mt-4">
                        <input type="checkbox" id="consent-result" class="mt-1" checked>
                        <label for="consent-result" class="text-sm text-gray-600">We'll email only about <span class="fsa-placeholder"></span> coverage and monthly alerts. Unsubscribe anytime. <a href="#" class="underline">Privacy Policy</a>.</label>
                    </div>
                    <button type="submit" class="lead-gen-button w-full bg-[#8c6d44] text-white font-bold py-3 px-4 rounded-lg mt-6 hover:bg-[#7a5f3a] transition-transform transform hover:scale-105"></button>
                </form>
            </div>
        </div>
    </template>

    <template id="no-result-template">
        <div class="bg-white/90 backdrop-blur-md p-4 md:p-6 rounded-xl shadow-2xl text-gray-800 fade-in">
         <button class="change-area-btn text-blue-600 font-semibold mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            Change area
        </button>
        <div class="bg-green-100 text-green-800 p-4 rounded-lg mb-4">
            <h3 class="text-xl font-bold text-[#0F2A3D] tracking-[-0.25px]">Good news: no reported break-ins in <span class="fsa-placeholder"></span> in the last 30 days.</h3>
            <p class="text-sm">Source: York Regional Police</p>
        </div>
        <a href="#" class="view-map-btn block py-3 border-b border-gray-300 hover:bg-gray-100/50 rounded-t-lg px-2 flex justify-between items-center mb-4">
            Open York Region map
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
        </a>
        <div id="comparison-list-container">
            <h4 class="text-lg font-semibold mb-2 text-[#0F2A3D] tracking-[-0.25px]">Recent Break-ins by Area</h4>
            <ul id="comparison-list" class="divide-y divide-gray-200">
                <!-- List items will be injected here -->
            </ul>
            <a href="#" id="view-all-btn" class="block text-blue-600 font-semibold mt-2 py-2">View all (9)</a>
        </div>
        <div class="mt-4 pt-6 border-t border-gray-300">
            <h3 class="lead-gen-heading text-2xl font-bold mb-1 text-[#0F2A3D] tracking-[-0.25px]"></h3>
            <form class="lead-gen-form">
                <input type="email" required placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mt-2 focus:ring-2 focus:ring-blue-500">
                <div class="flex items-start gap-2 mt-4">
                    <input type="checkbox" id="consent-no-result" class="mt-1" checked>
                    <label for="consent-no-result" class="text-sm text-gray-600">We'll email only about <span class="fsa-placeholder"></span> coverage and monthly alerts. Unsubscribe anytime. <a href="#" class="underline">Privacy Policy</a>.</label>
                </div>
                <button type="submit" class="lead-gen-button w-full bg-[#8c6d44] text-white font-bold py-3 px-4 rounded-lg mt-6 hover:bg-[#7a5f3a] transition-transform transform hover:scale-105"></button>
            </form>
        </div>
    </div>
    </template>
    
    <template id="not-supported-template">
        <div class="bg-white p-4 md:p-8 rounded-xl shadow-2xl fade-in">
            <button class="change-area-btn text-blue-600 font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                Change area
            </button>
            <h2 class="text-3xl font-bold text-gray-800 text-[#0F2A3D] tracking-[-0.25px]">Coverage coming soon to <span class="fsa-placeholder"></span></h2>
            <p class="text-gray-600 my-4">We're expanding our map. Be first to know when <span class="fsa-placeholder"></span> goes live.</p>
            <form class="lead-gen-form">
                <input type="email" required placeholder="name@domain.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg mt-4 focus:ring-2 focus:ring-blue-500">
                <div class="flex items-start gap-2 mt-4 text-left">
                    <input type="checkbox" id="consent-not-supported" class="mt-1" checked>
                    <label for="consent-not-supported" class="text-sm text-gray-600">We'll email only about <span class="fsa-placeholder"></span> coverage and monthly alerts. Unsubscribe anytime. <a href="#" class="underline">Privacy Policy</a>.</label>
                </div>
                <button type="submit" class="w-full bg-[#8c6d44] text-white font-bold py-3 px-4 rounded-lg mt-6 hover:bg-[#7a5f3a] transition-transform transform hover:scale-105">Join the <span class="fsa-placeholder"></span> waitlist</button>
            </form>
        </div>
    </template>

    <template id="municipal-data-template">
        <div class="bg-white/90 backdrop-blur-md p-4 md:p-6 rounded-xl shadow-2xl text-gray-800 fade-in w-full">
        <button class="back-to-results-btn text-blue-600 font-semibold mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            Back to dashboard
        </button>
        <!-- Dashboard Card -->
        <div class="bg-[#0e2a47] text-white p-6 rounded-lg mb-4">
            <h3 class="text-xl font-semibold mb-1 text-white tracking-[-0.25px]">York Region Break-ins</h3>
            <p class="text-sm text-gray-300 mb-4">Source: York Regional Police</p>
            <div class="flex justify-around text-left">
                <div>
                    <p class="text-5xl font-bold" id="dashboard-monthly-count">0</p>
                    <p class="text-gray-300 text-sm">Last 30 Days</p>
                </div>
                <div class="border-l border-gray-500"></div>
                <div>
                    <p class="text-5xl font-bold" id="dashboard-yearly-count">0</p>
                    <p class="text-gray-300 text-sm">Last 12 months</p>
                </div>
            </div>
        </div>
        <!-- Move Open York Region map button here -->
        <a href="#" class="view-map-btn block py-3 border-b border-gray-300 hover:bg-gray-100/50 rounded-lg px-2 flex justify-between items-center mb-4">
            Open York Region map
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
        </a>
        <div id="comparison-list-container">
            <h4 class="text-lg font-semibold mb-2 text-[#0F2A3D] tracking-[-0.25px]">Recent Break-ins by Area</h4>
            <ul id="comparison-list" class="divide-y divide-gray-200">
                <!-- List items will be injected here -->
            </ul>
            <a href="#" id="view-all-btn" class="block text-blue-600 font-semibold mt-2 py-2">View all (9)</a>
        </div>
        <div class="mt-4 pt-6 border-t border-gray-300">
            <h3 class="lead-gen-heading text-2xl font-bold mb-1 text-[#0F2A3D] tracking-[-0.25px]">Get Your <span class="fsa-placeholder"> Safety Alerts</span></h3>
            <form class="lead-gen-form">
                <input type="email" required placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mt-2 focus:ring-2 focus:ring-blue-500">
                <div class="flex items-start gap-2 mt-4">
                    <input type="checkbox" id="consent-municipal" class="mt-1" checked>
                    <label for="consent-municipal" class="text-sm text-gray-600">We'll email only about <span class="fsa-placeholder"></span> coverage and monthly alerts. Unsubscribe anytime. <a href="#" class="underline">Privacy Policy</a>.</label>
                </div>
                <button type="submit" class="lead-gen-button w-full bg-[#8c6d44] text-white font-bold py-3 px-4 rounded-lg mt-6 hover:bg-[#7a5f3a] transition-transform transform hover:scale-105">Get Free Alerts</button>
            </form>
        </div>
    </div>
    </template>

    <template id="map-template">
        <div class="bg-white/90 backdrop-blur-md p-4 md:p-6 rounded-xl shadow-2xl text-gray-800 fade-in w-full">
            <button class="back-to-results-btn text-blue-600 font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                Back to dashboard
            </button>
            <h3 class="text-xl font-bold mb-1 text-[#0F2A3D] tracking-[-0.25px]">Recent Break-ins (Last 30 Days)</h3>
            <p class="text-sm text-gray-500 mb-4">Source: York Regional Police</p>
            <div id="map" class="w-full aspect-square rounded-lg overflow-hidden z-10">
                 <!-- Leaflet map will be initialized here -->
            </div>
            <div class="mt-4 pt-6 border-t border-gray-300">
                <h3 class="lead-gen-heading text-2xl font-bold mb-1 text-[#0F2A3D] tracking-[-0.25px]"></h3>
                <form class="lead-gen-form">
                    <input type="email" required placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg mt-2 focus:ring-2 focus:ring-blue-500">
                    <div class="flex items-start gap-2 mt-4">
                        <input type="checkbox" id="consent-map" class="mt-1" checked>
                        <label for="consent-map" class="text-sm text-gray-600">We'll email only about <span class="fsa-placeholder"></span> coverage and monthly alerts. Unsubscribe anytime. <a href="#" class="underline">Privacy Policy</a>.</label>
                    </div>
                    <button type="submit" class="lead-gen-button w-full bg-[#8c6d44] text-white font-bold py-3 px-4 rounded-lg mt-6 hover:bg-[#7a5f3a] transition-transform transform hover:scale-105">
                        Get Free Safety Alerts
                    </button>
                </form>
            </div>
        </div>
    </template>
    
    <!-- LeafletJS Script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const homeScreen = document.getElementById('home-screen');
            const contentContainer = document.getElementById('content-container');
            const searchForm = document.getElementById('search-form');
            const fsaInput = document.getElementById('fsa-input');
            const searchBtn = document.getElementById('search-btn');
            const errorMessage = document.getElementById('error-message');
            const resultTemplate = document.getElementById('result-template');
            const notSupportedTemplate = document.getElementById('not-supported-template');
            const noResultTemplate = document.getElementById('no-result-template');
            const municipalDataTemplate = document.getElementById('municipal-data-template');
            const mapTemplate = document.getElementById('map-template');

            let state = {
                currentFSA: null,
                lastResultData: null,
                lastScreen: 'home'
            };

            fsaInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fsa = fsaInput.value.trim().toUpperCase();
                const fsaRegex = /^[A-Z]\d[A-Z]$/;
                if (!fsaRegex.test(fsa)) {
                    errorMessage.textContent = "Please enter a valid FSA (e.g. M5V, L4C, K1A).";
                    return;
                }
                errorMessage.textContent = '';
                state.currentFSA = fsa;

                searchBtn.disabled = true;
                searchBtn.querySelector('.btn-text').classList.add('hidden');
                searchBtn.querySelector('.btn-spinner').classList.remove('hidden');

                try {
                    const response = await fetch(`./data/${fsa}.json`);
                    if (!response.ok) {
                        displayNotSupported(fsa);
                        return;
                    }
                    const data = await response.json();
                    state.lastResultData = data;
                    
                    const today = new Date();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(today.getDate() - 30);

                    const monthlyCount = data.filter(rec => new Date(rec['occurrence_date']) >= thirtyDaysAgo).length;

                    if (monthlyCount > 0) {
                        displayResults(fsa, data, monthlyCount);
                    } else {
                        displayNoResults(fsa, data);
                    }

                } catch (error) {
                    errorMessage.textContent = "Could not connect to the data source.";
                    console.error("Fetch error:", error);
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.querySelector('.btn-text').classList.remove('hidden');
                    searchBtn.querySelector('.btn-spinner').classList.add('hidden');
                }
            });

            function displayResults(fsa, records, monthlyCount) {
                state.lastScreen = 'results';
                homeScreen.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                contentContainer.innerHTML = '';

                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const yearlyCount = records.filter(rec => new Date(rec['occurrence_date']) >= oneYearAgo).length;

                const template = resultTemplate.content.cloneNode(true);
                template.getElementById('result-fsa-header').textContent = `${fsa} Break-ins`;
                template.getElementById('result-monthly-count').textContent = monthlyCount;
                template.getElementById('result-yearly-count').textContent = yearlyCount;
                template.querySelectorAll('.fsa-placeholder').forEach(el => el.textContent = fsa);

                // Change lead gen headline and sub-headline
                const leadGenHeading = template.querySelector('.lead-gen-heading');
                leadGenHeading.textContent = "Know What's Happening in Your Area";
                let subHeadline = document.createElement('p');
                subHeadline.className = "text-base text-gray-700 mb-2";
                subHeadline.textContent = `There were ${monthlyCount} break-ins reported in ${fsa} last month. Get free monthly alerts to stay aware.`;
                // Insert sub-headline after the headline
                leadGenHeading.insertAdjacentElement('afterend', subHeadline);

                template.querySelector('.lead-gen-button').textContent = `Get My Free ${fsa} Alerts`;
                
                contentContainer.appendChild(template);
                addCommonEventListeners();
            }

            async function displayNoResults(fsa, records) {
                state.lastScreen = 'no-results';
                homeScreen.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                contentContainer.innerHTML = '';

                const template = noResultTemplate.content.cloneNode(true);
                template.querySelectorAll('.fsa-placeholder').forEach(el => el.textContent = fsa);
                template.querySelector('.lead-gen-heading').textContent = `Get Your ${fsa} Safety Alerts.`;
                template.querySelector('.lead-gen-button').textContent = `Get My Free ${fsa} Alerts`;
                
                contentContainer.appendChild(template);
                
                try {
                    const response = await fetch('./data/monthly_summary.json');
                    if (!response.ok) throw new Error('Could not load summary data.');
                    const summaryData = await response.json();
                    
                    const list = contentContainer.querySelector('#comparison-list');
                    const viewAllBtn = contentContainer.querySelector('#view-all-btn');
                    list.innerHTML = '';
                    const summaryEntries = Object.entries(summaryData);

                    // Render all rows, hide after 3 by default
                    summaryEntries.forEach(([municipality, count], idx) => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center py-2 md:py-3';
                        li.innerHTML = `<span>${municipality}</span><span class="font-semibold">${count}</span>`;
                        if (idx >= 3) li.classList.add('hidden');
                        list.appendChild(li);
                    });

                    if (summaryEntries.length > 3) {
                        viewAllBtn.textContent = `View all (${summaryEntries.length})`;
                        let expanded = false;
                        // Hide extra rows by default
                        list.querySelectorAll('li').forEach((li, idx) => {
                            if (idx >= 3) li.classList.add('hidden');
                        });
                        viewAllBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            expanded = !expanded;
                            list.querySelectorAll('li').forEach((li, idx) => {
                                if (idx >= 3) li.classList.toggle('hidden', !expanded);
                            });
                            viewAllBtn.textContent = expanded ? 'Show less' : `View all (${summaryEntries.length})`;
                        });
                    } else {
                        viewAllBtn.style.display = 'none';
                    }
                } catch(e) {
                    console.error("Could not load comparison data for no-results page:", e);
                }

                addCommonEventListeners();
            }

            function displayNotSupported(fsa) {
                state.lastScreen = 'not-supported';
                homeScreen.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                contentContainer.innerHTML = '';

                const template = notSupportedTemplate.content.cloneNode(true);
                template.querySelectorAll('.fsa-placeholder').forEach(el => el.textContent = fsa);
                contentContainer.appendChild(template);
                addCommonEventListeners();
            }

            async function displayMunicipalData() {
                state.lastScreen = 'municipal';
                homeScreen.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                contentContainer.innerHTML = '';

                try {
                    // Fetch both summary and totals
                    const [summaryRes, totalsRes] = await Promise.all([
                        fetch('./data/monthly_summary.json'),
                        fetch('./data/york_totals.json')
                    ]);
                    if (!summaryRes.ok) throw new Error('Could not load summary data.');
                    if (!totalsRes.ok) throw new Error('Could not load York Region totals.');
                    const summaryData = await summaryRes.json();
                    const yorkTotals = await totalsRes.json();

                    const template = municipalDataTemplate.content.cloneNode(true);

                    // Set dashboard totals
                    template.getElementById('dashboard-monthly-count').textContent = yorkTotals.monthly;
                    template.getElementById('dashboard-yearly-count').textContent = yorkTotals.yearly;

                    // Set comparison list
                    const list = template.getElementById('comparison-list');
                    const viewAllBtn = template.getElementById('view-all-btn');
                    list.innerHTML = '';
                    const summaryEntries = Object.entries(summaryData);

                    summaryEntries.forEach(([municipality, count], index) => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center py-2 md:py-3';
                        li.innerHTML = `<span>${municipality}</span><span class="font-semibold text-lg">${count}</span>`;
                        if (index >= 3) { // Show only 3 by default
                            li.classList.add('hidden');
                        }
                        list.appendChild(li);
                    });

                    if (summaryEntries.length > 3) {
                        viewAllBtn.textContent = `View all (${summaryEntries.length})`;
                        viewAllBtn.style.display = 'block';

                        viewAllBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            let isNowCollapsed = false;
                            list.querySelectorAll('li').forEach((li, index) => {
                                if (index >= 3) {
                                    li.classList.toggle('hidden');
                                    if(index === 3) {
                                        isNowCollapsed = li.classList.contains('hidden');
                                    }
                                }
                            });
                            viewAllBtn.textContent = isNowCollapsed ? `View all (${summaryEntries.length})` : 'Show less';
                        });
                    } else {
                        viewAllBtn.style.display = 'none';
                    }

                    contentContainer.appendChild(template);
                    contentContainer.querySelectorAll('.fsa-placeholder').forEach(el => el.textContent = state.currentFSA);
                    contentContainer.querySelector('.lead-gen-heading').textContent = `Get Your ${state.currentFSA} Safety Alerts`;
                    contentContainer.querySelector('.lead-gen-button').textContent = `Get My Free ${state.currentFSA} Alerts`;
                    addCommonEventListeners();

                } catch (error) {
                    errorMessage.textContent = error.message;
                    console.error("Summary fetch error:", error);
                }
            }
            
            async function displayMap() {
                state.lastScreen = 'map';
                homeScreen.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                contentContainer.innerHTML = '';

                try {
                    const template = mapTemplate.content.cloneNode(true);
                    contentContainer.appendChild(template);

                    const map = L.map('map').setView([43.95, -79.45], 10);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">'
                    }).addTo(map);

                    // Only use GeoJSON for rendering points
                    fetch('./data/map_data.geojson')
                        .then(res => res.json())
                        .then(geojson => {
                            L.geoJSON(geojson, {
                                onEachFeature: function (feature, layer) {
                                    if (feature.properties && feature.properties.fsa && feature.properties.municipality) {
                                        layer.bindTooltip(`<b>${feature.properties.fsa}</b><br>${feature.properties.municipality}`);
                                    }
                                }
                            }).addTo(map);
                        })
                        .catch(err => {
                            errorMessage.textContent = "Could not load map data.";
                            console.error("GeoJSON fetch error:", err);
                        });

                    // Set dynamic heading and button
                    const fsa = state.currentFSA || 'your area';
                    contentContainer.querySelector('.lead-gen-heading').textContent =
                        `Get Your ${fsa} Safety Alerts`;
                    contentContainer.querySelector('.lead-gen-button').textContent = `Get My Free ${fsa} Alerts`;
                    addCommonEventListeners();

                } catch (error) {
                    errorMessage.textContent = error.message;
                    console.error("Map fetch error:", error);
                }
            }

            function addCommonEventListeners() {
                contentContainer.querySelector('.change-area-btn')?.addEventListener('click', () => {
                    homeScreen.classList.remove('hidden');
                    contentContainer.classList.add('hidden');
                    fsaInput.value = '';
                });

                contentContainer.querySelector('.view-comparison-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    displayMunicipalData();
                });
                
                contentContainer.querySelector('.view-map-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    displayMap();
                });

                contentContainer.querySelector('.back-to-results-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    const today = new Date();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    const monthlyCount = state.lastResultData.filter(rec => new Date(rec['occurrence_date']) >= thirtyDaysAgo).length;

                    if (monthlyCount > 0) {
                         displayResults(state.currentFSA, state.lastResultData, monthlyCount);
                    } else {
                        displayNoResults(state.currentFSA, state.lastResultData);
                    }
                });
            }
        });
    </script>
</body>
</html>
